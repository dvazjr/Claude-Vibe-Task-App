{% extends 'base.html' %}
{% block title %}Home - Task Planner{% endblock %}
{% block content %}
<!-- CSRF Token for API calls -->
{% csrf_token %}
<div class="container my-5">
  <div class="main-container p-5">
    <div class="text-center mb-5">
      <h1 class="display-4 fw-bold text-dark mb-3">Task Planner</h1>
      <p class="lead text-muted mx-auto" style="max-width: 600px">
        Organize your life, one task at a time. Stay productive and achieve your
        goals with our powerful task management system.
      </p>
    </div>

    {% if user.is_authenticated %}
    <div class="text-center">
      <div
        class="p-4 mb-4 text-white rounded-4"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
      >
        <h2 class="mb-3">Welcome back, {{ user.username }}!</h2>
        <p class="mb-0 fs-5" style="opacity: 0.9">
          Ready to tackle your tasks today?
        </p>
      </div>

      <div class="row g-4 mt-3">
        <div class="col-md-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
              <h3 class="mb-3" style="color: #667eea">üìã My Tasks</h3>
              <p class="text-muted mb-4">View and manage your current tasks</p>
              <a href="#" class="btn btn-primary-gradient px-4 py-2" id="view-tasks-btn"
                >View Tasks</a
              >
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
              <h3 class="mb-3" style="color: #667eea">üìÖ Calendar</h3>
              <p class="text-muted mb-4">Check your schedule and deadlines</p>
              <a
                href="#"
                class="btn btn-primary-gradient px-4 py-2"
                id="calendar-btn"
                >View Calendar</a
              >
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
              <h3 class="mb-3" style="color: #667eea">‚ûï New Task</h3>
              <p class="text-muted mb-4">Create a new task or project</p>
              <button type="button" class="btn btn-primary-gradient px-4 py-2" data-bs-toggle="modal" data-bs-target="#taskModal">
                Add Task
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="text-center">
      <div
        class="p-5 mb-4 rounded-4"
        style="background: rgba(255, 255, 255, 0.8)"
      >
        <h2 class="fw-bold text-dark mb-3">Get Started Today</h2>
        <p class="lead text-muted mb-4">
          Join thousands of users who are already organizing their tasks
          efficiently
        </p>

        <div class="d-flex gap-3 justify-content-center flex-wrap">
          <a
            href="{% url 'register' %}"
            class="btn btn-primary-gradient px-4 py-3"
            >Create Account</a
          >
          <a
            href="{% url 'login' %}"
            class="btn btn-outline-primary-gradient px-4 py-3"
            >Sign In</a
          >
        </div>
      </div>

      <div class="row g-4 mt-3">
        <div class="col-md-4">
          <div class="text-center">
            <div class="display-1 mb-3">üìù</div>
            <h3 class="text-dark mb-2">Easy Task Creation</h3>
            <p class="text-muted">Quickly add and organize your tasks</p>
          </div>
        </div>

        <div class="col-md-4">
          <div class="text-center">
            <div class="display-1 mb-3">‚è∞</div>
            <h3 class="text-dark mb-2">Smart Reminders</h3>
            <p class="text-muted">Never miss a deadline again</p>
          </div>
        </div>

        <div class="col-md-4">
          <div class="text-center">
            <div class="display-1 mb-3">üìä</div>
            <h3 class="text-dark mb-2">Progress Tracking</h3>
            <p class="text-muted">Monitor your productivity</p>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Task Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="border-radius: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
      <div class="modal-header" style="border: none; color: white;">
        <h4 class="modal-title" id="taskModalLabel">Create New Task</h4>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="taskForm">
        <div class="modal-body" style="background-color: white; margin: 0 1rem 1rem 1rem; border-radius: 15px; padding: 2rem;">

          <!-- Date Selector -->
          <div class="mb-4">
            <label class="form-label fw-bold" style="color: #667eea;">Select Date</label>
            <input type="date" id="taskDate" class="form-control" style="border-radius: 10px; border: 2px solid #667eea;" required>
          </div>

          <!-- Time Slots -->
          <div class="mb-4">
            <label class="form-label fw-bold" style="color: #667eea;">Select Time Slots <span class="text-danger">*</span></label>
            <div class="row g-2" id="timeSlots">
              <!-- Time slots will be generated by JavaScript -->
            </div>
          </div>

          <!-- Task Description -->
          <div class="mb-4">
            <label class="form-label fw-bold" style="color: #667eea;">Task Description</label>
            <textarea id="taskText" class="form-control" rows="4" placeholder="Enter your task description..."
                      style="border-radius: 10px; border: 2px solid #667eea;" required></textarea>
          </div>

          <!-- Text Formatting -->
          <div class="mb-4">
            <label class="form-label fw-bold" style="color: #667eea;">Text Formatting</label>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Font Size</label>
                <select id="fontSize" class="form-select" style="border-radius: 8px; border: 2px solid #e1e5e9;">
                  <option value="12">12px</option>
                  <option value="14">14px</option>
                  <option value="16" selected>16px</option>
                  <option value="18">18px</option>
                  <option value="20">20px</option>
                  <option value="24">24px</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Font Weight</label>
                <select id="fontWeight" class="form-select" style="border-radius: 8px; border: 2px solid #e1e5e9;">
                  <option value="normal" selected>Normal</option>
                  <option value="bold">Bold</option>
                  <option value="lighter">Light</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Font Style</label>
                <select id="fontStyle" class="form-select" style="border-radius: 8px; border: 2px solid #e1e5e9;">
                  <option value="normal" selected>Normal</option>
                  <option value="italic">Italic</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Preview -->
          <div class="mb-4">
            <label class="form-label fw-bold" style="color: #667eea;">Preview</label>
            <div id="textPreview" class="p-3 bg-light rounded" style="min-height: 50px; border: 2px solid #e1e5e9;">
              Your task description will appear here...
            </div>
          </div>

        </div>

        <div class="modal-footer" style="border: none; padding: 1rem 2rem;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Cancel</button>
          <button type="submit" class="btn btn-primary-gradient" style="border-radius: 10px;">Create Task</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Set today's date as default
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('taskDate').value = today;

  // Generate time slots
  const timeSlots = [
    '06:00', '07:00', '08:00', '09:00', '10:00', '11:00',
    '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
    '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'
  ];

  const timeSlotsContainer = document.getElementById('timeSlots');
  timeSlots.forEach(time => {
    const col = document.createElement('div');
    col.className = 'col-3 mb-2';
    col.innerHTML = `
      <label class="d-flex align-items-center" style="cursor: pointer;">
        <input type="checkbox" name="timeSlot" value="${time}" class="me-2">
        <span class="badge bg-light text-dark time-slot-badge" style="padding: 0.5rem; border-radius: 8px; font-size: 0.85rem;">
          ${time}
        </span>
      </label>
    `;
    timeSlotsContainer.appendChild(col);
  });

  // Update preview when text or formatting changes
  function updatePreview() {
    const text = document.getElementById('taskText').value;
    const fontSize = document.getElementById('fontSize').value;
    const fontWeight = document.getElementById('fontWeight').value;
    const fontStyle = document.getElementById('fontStyle').value;

    const preview = document.getElementById('textPreview');
    preview.style.fontSize = fontSize + 'px';
    preview.style.fontWeight = fontWeight;
    preview.style.fontStyle = fontStyle;
    preview.textContent = text || 'Your task description will appear here...';

    // Also update textarea styling
    const textarea = document.getElementById('taskText');
    textarea.style.fontSize = fontSize + 'px';
    textarea.style.fontWeight = fontWeight;
    textarea.style.fontStyle = fontStyle;
  }

  // Bind preview updates
  document.getElementById('taskText').addEventListener('input', updatePreview);
  document.getElementById('fontSize').addEventListener('change', updatePreview);
  document.getElementById('fontWeight').addEventListener('change', updatePreview);
  document.getElementById('fontStyle').addEventListener('change', updatePreview);

  // Update time slot badge styling when selected
  document.addEventListener('change', function(e) {
    if (e.target.name === 'timeSlot') {
      const badge = e.target.nextElementSibling;
      if (e.target.checked) {
        badge.className = 'badge text-white time-slot-badge';
        badge.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      } else {
        badge.className = 'badge bg-light text-dark time-slot-badge';
        badge.style.background = '';
      }
    }
  });

  // Handle form submission
  document.getElementById('taskForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const selectedTimeSlots = Array.from(document.querySelectorAll('input[name="timeSlot"]:checked')).map(cb => cb.value);
    const taskText = document.getElementById('taskText').value.trim();

    if (!taskText) {
      // Highlight the text area
      const textArea = document.getElementById('taskText');
      textArea.style.border = '2px solid red';
      textArea.focus();

      alert('‚ö†Ô∏è Please enter a task description.');

      // Remove highlight after 3 seconds
      setTimeout(() => {
        textArea.style.border = '';
      }, 3000);

      return;
    }

    if (selectedTimeSlots.length === 0) {
      // Highlight time slots section to draw attention
      const timeSlotsContainer = document.getElementById('timeSlots');
      timeSlotsContainer.style.border = '2px solid red';
      timeSlotsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

      alert('‚ö†Ô∏è Please select at least one time slot before creating the task.');

      // Remove highlight after 3 seconds
      setTimeout(() => {
        timeSlotsContainer.style.border = '';
      }, 3000);

      return;
    }

    const taskData = {
      date: document.getElementById('taskDate').value,
      time_slots: selectedTimeSlots,
      text: taskText,
      font_size: parseInt(document.getElementById('fontSize').value),
      font_weight: document.getElementById('fontWeight').value,
      font_style: document.getElementById('fontStyle').value
    };

    try {
      // Get CSRF token
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                       document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                       document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

      console.log('CSRF Token found:', csrfToken);
      console.log('Creating tasks with data:', taskData);
      console.log('Current URL:', window.location.href);
      console.log('API URL will be:', window.location.origin + '/api/tasks/create-multiple/');

      if (!csrfToken) {
        alert('Error: CSRF token not found. Please refresh the page and try again.');
        return;
      }

      const response = await fetch('/api/tasks/create-multiple/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        credentials: 'same-origin',
        body: JSON.stringify(taskData)
      });

      if (response.ok) {
        const result = await response.json();
        console.log('Tasks created:', result);

        // Also save to localStorage for existing calendar compatibility
        const existingTasks = JSON.parse(localStorage.getItem('taskPlannerTasks') || '{}');

        // Fix timezone issue: create date with explicit local timezone
        const dateParts = taskData.date.split('-');
        const year = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
        const day = parseInt(dateParts[2]);
        const localDate = new Date(year, month, day);
        const dateKey = localDate.toDateString();

        console.log('Task creation - original date:', taskData.date);
        console.log('Task creation - date key generated:', dateKey);
        console.log('Task creation - existing tasks before update:', existingTasks);

        if (!existingTasks[dateKey]) {
          existingTasks[dateKey] = [];
        }

        // Add tasks with IDs from the API response
        result.tasks.forEach(task => {
          existingTasks[dateKey].push({
            id: task.id,
            time: task.time,
            text: task.text,
            completed: task.completed,
            formatting: {
              fontSize: task.font_size,
              fontWeight: task.font_weight,
              fontStyle: task.font_style
            }
          });
        });

        localStorage.setItem('taskPlannerTasks', JSON.stringify(existingTasks));
        console.log('Task creation - localStorage updated with:', existingTasks);

        // Update the main app's tasks if it exists and refresh them from database
        if (window.taskPlannerApp) {
          try {
            // Wait for app to be fully initialized if needed
            if (window.taskPlannerApp.initPromise) {
              await window.taskPlannerApp.initPromise;
            }

            // Force refresh tasks from database
            if (typeof window.taskPlannerApp.loadTasks === 'function') {
              const updatedTasks = await window.taskPlannerApp.loadTasks();
              window.taskPlannerApp.tasks = updatedTasks;
              console.log('Calendar tasks refreshed after task creation:', updatedTasks);
            } else {
              // Fallback: just update the tasks directly
              window.taskPlannerApp.tasks = existingTasks;
              console.log('Updated calendar tasks directly:', existingTasks);
            }
          } catch (error) {
            console.error('Error refreshing calendar tasks:', error);
            // Fallback: just update localStorage and let calendar load from there
            if (window.taskPlannerApp.tasks !== undefined) {
              window.taskPlannerApp.tasks = existingTasks;
            }
          }
        }

        // Close modal and reset form
        bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
        document.getElementById('taskForm').reset();
        document.getElementById('taskDate').value = today;
        updatePreview();

        // Add a debug check button temporarily
        const existingDebug = document.getElementById('debug-tasks');
        if (!existingDebug) {
          const debugBtn = document.createElement('button');
          debugBtn.id = 'debug-tasks';
          debugBtn.textContent = 'Debug: Check Tasks';
          debugBtn.className = 'btn btn-warning btn-sm';
          debugBtn.style.position = 'fixed';
          debugBtn.style.top = '10px';
          debugBtn.style.right = '10px';
          debugBtn.style.zIndex = '9999';
          debugBtn.onclick = () => {
            const localTasks = JSON.parse(localStorage.getItem('taskPlannerTasks') || '{}');
            console.log('=== DEBUG: Current localStorage tasks ===');
            console.log(localTasks);

            // Find most recent tasks
            let summary = 'Found date keys:\n';
            Object.keys(localTasks).forEach(dateKey => {
              const tasksForDate = localTasks[dateKey];
              summary += `${dateKey}: ${tasksForDate.length} tasks\n`;
              tasksForDate.forEach((task, i) => {
                summary += `  ${i+1}. ${task.time}: "${task.text}"\n`;
              });
            });

            alert(summary || 'No tasks found');
          };
          document.body.appendChild(debugBtn);

          // Add a test calendar button
          const testCalBtn = document.createElement('button');
          testCalBtn.id = 'test-calendar';
          testCalBtn.textContent = 'Test: Show Calendar';
          testCalBtn.className = 'btn btn-info btn-sm';
          testCalBtn.style.position = 'fixed';
          testCalBtn.style.top = '50px';
          testCalBtn.style.right = '10px';
          testCalBtn.style.zIndex = '9999';
          testCalBtn.onclick = () => {
            if (window.taskPlannerApp) {
              window.taskPlannerApp.explodeToCalendar();
            } else {
              alert('TaskPlannerApp not initialized yet');
            }
          };
          document.body.appendChild(testCalBtn);
        }

        alert(result.message || 'Tasks created successfully! \n\n‚úì Go to View Calendar to see your new tasks.\n‚úì Click "Debug: Check Tasks" button to see stored tasks.');
      } else {
        console.error('HTTP Error:', response.status, response.statusText);
        let errorMessage = `Server Error (${response.status}): ${response.statusText}`;

        try {
          const errorData = await response.json();
          console.error('API Error Details:', errorData);
          errorMessage += '\n\nDetails: ' + JSON.stringify(errorData, null, 2);
        } catch (e) {
          // Response might not be JSON
          const errorText = await response.text();
          console.error('Non-JSON Error Response:', errorText);
          errorMessage += '\n\nResponse: ' + errorText.substring(0, 200);
        }

        alert('Error creating tasks:\n' + errorMessage);
      }
    } catch (error) {
      console.error('Network/Connection error:', error);
      let errorMessage = 'Network error occurred.\n\n';

      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        errorMessage += 'Possible causes:\n‚Ä¢ Server not running\n‚Ä¢ Network connection issue\n‚Ä¢ CORS policy blocking request';
      } else if (error.name === 'AbortError') {
        errorMessage += 'Request was cancelled or timed out.';
      } else {
        errorMessage += 'Error details: ' + error.message;
      }

      alert(errorMessage + '\n\nPlease check:\n1. Server is running on localhost:8000\n2. You are logged in\n3. Your internet connection');
    }
  });
});
</script>
{% endblock %}
